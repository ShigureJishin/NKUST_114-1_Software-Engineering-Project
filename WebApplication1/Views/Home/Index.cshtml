@{
    ViewData["Title"] = "Home";
}

<div class="text-center">
    <h1 class="display-4">Market Structure — Bar Chart</h1>
    <p>Counts of stocks up / down / unchanged for the day</p>
</div>

<!-- Date selector -->
<div style="text-align:center; margin-bottom:20px;">
    <input type="date" id="tradeDate" />
    <button onclick="loadChart()">Search</button>
</div>

<!-- 長條圖 -->
<div style="width:550px;margin:auto;">
    <canvas id="marketChart" height="400"></canvas> <!-- 設定高度 -->
</div>

<!-- Chart.js & Data Labels 插件 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
    let marketChart;

    // 取得最近有資料的日期（使用專門路由 /latest），並回填到日期欄位
    async function getLatestDate() {
        try {
            const res = await fetch('/api/stockapi/market-summary/latest');
            const data = await res.json();
            if (data.latestDate) {
                document.getElementById('tradeDate').value = data.latestDate;
                // 若 latestDate 不是今天，提醒使用者今日資料未更新
                const todayStr = new Date().toISOString().slice(0, 10);
                if (data.latestDate !== todayStr) {
                    alert('Today\'s data is not yet updated');
                }
            } else {
                document.getElementById('tradeDate').value = new Date().toISOString().slice(0, 10);
            }
        } catch (e) {
            console.error(e);
            document.getElementById('tradeDate').value = new Date().toISOString().slice(0, 10);
        }
    }

    // 讀取並顯示長條圖。若沒有指定日期或指定日期為空，則向 /latest 取最新一日資料
    async function loadChart() {
        let date = document.getElementById('tradeDate').value;
        let url;
        if (!date) {
            url = '/api/stockapi/market-summary/latest';
        } else {
            url = `/api/stockapi/market-summary?date=${date}`;
        }

        try {
            const res = await fetch(url);
            let data = await res.json();

            // 若後端回傳 message 表示無資料或錯誤
            if (data.message && data.message.length > 0) {
                const todayStr = new Date().toISOString().slice(0, 10);
                // 當使用者查詢的是今日，改為自動嘗試向 /latest 取得最近有資料的一日
                if (date === todayStr) {
                    try {
                        const res2 = await fetch('/api/stockapi/market-summary/latest');
                        const data2 = await res2.json();
                        if (!(data2.message && data2.message.length > 0)) {
                            // 今日資料未更新，改用最近一日資料並告知使用者
                            alert('Today\'s data is not yet updated');
                            data = data2; // 使用最新一日的資料繼續畫圖
                        } else {
                            alert('Today\'s data is not yet updated');
                            if (marketChart) marketChart.destroy();
                            return;
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Today\'s data is not yet updated');
                        if (marketChart) marketChart.destroy();
                        return;
                    }
                } else {
                    alert(data.message);
                    if (marketChart) marketChart.destroy();
                    return;
                }
            }

            const up = Number(data.up ?? 0);
            const down = Number(data.down ?? 0);
            const flat = Number(data.flat ?? 0);
            const values = [up, down, flat];

            if (marketChart) marketChart.destroy();

            const ctx = document.getElementById('marketChart');

            const maxVal = Math.max(...values);
            const suggestedMax = maxVal > 0 ? Math.ceil(maxVal * 1.2) : 1;
            const stepSize = Math.ceil(suggestedMax / 5) || 1;

            marketChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Up', 'Down', 'Unchanged'],
                    datasets: [{
                        label: 'Count',
                        data: values,
                        backgroundColor: ['#ff4d4d', '#4da6ff', '#cccccc'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            clamp: true,
                            color: '#000',
                            font: { weight: 'bold', size: 14 },
                            formatter: function (value) { return value; }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            ticks: { stepSize: stepSize }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // 若後端有回傳最新日期，回填日期欄位（例如使用 /latest）
            if (data.latestDate) {
                document.getElementById('tradeDate').value = data.latestDate;
            }

        } catch (error) {
            console.error(error);
            alert('Failed to retrieve data!');
        }
    }

    // 頁面載入先取得最近有資料的日期，再載入圖表
    getLatestDate().then(() => loadChart());
</script>
