@model WebApplication1.Models.StockListViewModel

@{
    ViewData["Title"] = "Stocks";
    string ToggleDir(string col)
    {
        if (Model.Sort == col)
        {
            return Model.SortDir == "asc" ? "desc" : "asc";
        }
        return "asc";
    }
    string SortIndicator(string col)
    {
        if (Model.Sort == col)
        {
			Console.WriteLine("SortIndicator called for column: " + col + " with direction: " + Model.SortDir);
            return Model.SortDir == "asc" ? " ↑" : " ↓";
        }
        return string.Empty;
    }

    var idToggle = ToggleDir("Id");
    var idIndicator = SortIndicator("Id");
    var codeToggle = ToggleDir("StockCode");
    var codeIndicator = SortIndicator("StockCode");
    var nameToggle = ToggleDir("StockName");
    var nameIndicator = SortIndicator("StockName");
    var priceToggle = ToggleDir("ClosingPrice");
    var priceIndicator = SortIndicator("ClosingPrice");
    var updatedToggle = ToggleDir("CreatedAt");
    var updatedIndicator = SortIndicator("CreatedAt");
}

<h1>Stocks</h1>

<form method="get" class="row g-2 mb-3">
    <div class="col-auto">
        <label class="form-label">Search Field</label>
        <select name="searchField" class="form-select">
            @if (Model.SearchField == "StockCode")
            {
                <option value="StockCode" selected>StockCode</option>
            }
            else
            {
                <option value="StockCode">StockCode</option>
            }
            @if (Model.SearchField == "StockName")
            {
                <option value="StockName" selected>StockName</option>
            }
            else
            {
                <option value="StockName">StockName</option>
            }
        </select>
    </div>
    <div class="col-auto">
        <label class="form-label">Search Term</label>
        <input type="text" name="searchTerm" value="@Model.SearchTerm" class="form-control" placeholder="Enter term" />
    </div>

    <div class="col-auto align-self-end">
        <input type="hidden" name="sort" value="@Model.Sort" />
        <input type="hidden" name="sortDir" value="@Model.SortDir" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" />
        <input type="hidden" name="page" value="1" />
        <button type="submit" class="btn btn-primary">Search</button>
        <a class="btn btn-secondary" href="?page=1&pageSize=@Model.PageSize">Reset</a>
    </div>
</form>

<table class="table table-striped">
    <thead>
        <tr>
            <th><a asp-action="Index" asp-route-page="1" asp-route-pageSize="@Model.PageSize" asp-route-sort="Id" asp-route-sortDir="@idToggle" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">Id@(idIndicator)</a></th>
            <th><a asp-action="Index" asp-route-page="1" asp-route-pageSize="@Model.PageSize" asp-route-sort="StockCode" asp-route-sortDir="@codeToggle" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">Symbol@(codeIndicator)</a></th>
            <th><a asp-action="Index" asp-route-page="1" asp-route-pageSize="@Model.PageSize" asp-route-sort="StockName" asp-route-sortDir="@nameToggle" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">Name@(nameIndicator)</a></th>
            <th class="text-end"><a asp-action="Index" asp-route-page="1" asp-route-pageSize="@Model.PageSize" asp-route-sort="ClosingPrice" asp-route-sortDir="@priceToggle" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">Price@(priceIndicator)</a></th>
            <th><a asp-action="Index" asp-route-page="1" asp-route-pageSize="@Model.PageSize" asp-route-sort="CreatedAt" asp-route-sortDir="@updatedToggle" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">UpdatedAt@(updatedIndicator)</a></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var s in Model.Stocks)
{
    <tr>
        <td>@s.Id</td>
        <td>@s.StockCode</td>
        <td>@s.StockName</td>
        <td class="text-end">@s.ClosingPrice</td>
        <td>@s.CreatedAt.ToString("g")</td>
        <td><a class="btn btn-sm btn-primary" asp-action="Details" asp-route-id="@s.Id">Details</a></td>
    </tr>
}
    </tbody>
</table>

<div class="d-flex justify-content-between align-items-center">
    <div>Showing @((Model.Page - 1) * Model.PageSize + 1)-@(((Model.Page - 1) * Model.PageSize) + Model.Stocks.Count()) of @Model.TotalCount</div>
    <nav>
        <ul class="pagination mb-0">
            <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                <a class="page-link" asp-action="Index" asp-route-page="@(Model.Page - 1)" asp-route-pageSize="@Model.PageSize" asp-route-sort="@Model.Sort" asp-route-sortDir="@Model.SortDir" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">Previous</a>
            </li>
@{
    var totalPages = (int)Math.Ceiling(Model.TotalCount / (double)Model.PageSize);
    for (int i = 1; i <= totalPages; i++)
    {
        <li class="page-item @(i == Model.Page ? "active" : "")"><a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-pageSize="@Model.PageSize" asp-route-sort="@Model.Sort" asp-route-sortDir="@Model.SortDir" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">@i</a></li>
    }
}
            <li class="page-item @(Model.Page >= (int)Math.Ceiling(Model.TotalCount / (double)Model.PageSize) ? "disabled" : "")">
                <a class="page-link" asp-action="Index" asp-route-page="@(Model.Page + 1)" asp-route-pageSize="@Model.PageSize" asp-route-sort="@Model.Sort" asp-route-sortDir="@Model.SortDir" asp-route-searchField="@Model.SearchField" asp-route-searchTerm="@Model.SearchTerm">Next</a>
            </li>
        </ul>
    </nav>
</div>
